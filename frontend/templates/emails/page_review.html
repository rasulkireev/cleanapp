{% load mjml %}

{% mjml %}
<mjml>
  <mj-head>
    <mj-attributes>
      <mj-all font-family="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" />
      <mj-text padding="0" />
    </mj-attributes>
    <mj-style>
      .summary-item {
        font-size: 13px;
        color: #4b5563;
        line-height: 1.7;
      }
      .page-line {
        font-size: 14px;
        color: #374151;
        line-height: 1.6;
      }
      .muted {
        color: #6b7280;
      }
      .title {
        color: #111827;
        font-weight: 600;
      }
    </mj-style>
  </mj-head>

  <mj-body background-color="#f9fafb">
    <mj-section background-color="#f9fafb" padding="32px 24px 20px">
      <mj-column>
        <mj-text font-size="24px" font-weight="700" color="#111827" align="center">
          Cleanapp
        </mj-text>
      </mj-column>
    </mj-section>

    <mj-section background-color="#f9fafb" padding="0 24px 24px">
      <mj-column>
        <mj-text font-size="16px" color="#111827" line-height="1.5" padding="0 0 10px 0">
          Hi {{ user.first_name|default:user.username }},
        </mj-text>
        <mj-text font-size="15px" color="#4b5563" line-height="1.6">
          {{ digest_period_label }} for your agency workspace. We found {{ total_due_pages }} due page{{ total_due_pages|pluralize }} and included {{ total_pages }} for one-click review now.
        </mj-text>
      </mj-column>
    </mj-section>

    <mj-section background-color="#f9fafb" padding="0 24px 24px">
      <mj-column background-color="#ffffff" border="1px solid #e5e7eb" border-radius="8px" padding="20px">
        <mj-text font-size="13px" font-weight="700" color="#374151" text-transform="uppercase" letter-spacing="0.6px" padding="0 0 12px 0">
          {% if is_weekly_summary %}Weekly Summary{% else %}Digest Summary{% endif %}
        </mj-text>
        <mj-text css-class="summary-item" padding="0 0 6px 0">• Clients: <span class="title">{{ total_clients }}</span></mj-text>
        <mj-text css-class="summary-item" padding="0 0 6px 0">• Active sites: <span class="title">{{ total_active_sites }}</span></mj-text>
        <mj-text css-class="summary-item" padding="0 0 6px 0">• Sites with due pages: <span class="title">{{ sites_with_due_pages }}</span></mj-text>
        <mj-text css-class="summary-item" padding="0">• Pages included in this email: <span class="title">{{ total_pages }}</span></mj-text>
      </mj-column>
    </mj-section>

    {% for client_group in client_groups %}
    <mj-section background-color="#f9fafb" padding="0 24px 12px">
      <mj-column>
        <mj-text font-size="13px" font-weight="700" color="#374151" text-transform="uppercase" letter-spacing="0.6px" padding="0 0 4px 0">
          Client: {{ client_group.client_label }}
        </mj-text>
        <mj-text font-size="13px" color="#6b7280" padding="0 0 8px 0">
          {{ client_group.sites_count }} site{{ client_group.sites_count|pluralize }} · {{ client_group.due_pages_count }} due page{{ client_group.due_pages_count|pluralize }}
        </mj-text>
      </mj-column>
    </mj-section>

      {% for sitemap_data in client_group.sites %}
      <mj-section background-color="#f9fafb" padding="0 24px {% if forloop.last and forloop.parentloop.last %}24{% else %}16{% endif %}px">
        <mj-column background-color="#ffffff" border="1px solid #e5e7eb" border-radius="8px" padding="20px">
          <mj-text font-size="14px" font-weight="600" color="#111827" padding="0 0 6px 0">
            {{ sitemap_data.sitemap.sitemap_url }}
          </mj-text>
          <mj-text font-size="13px" color="#6b7280" padding="0 0 12px 0">
            {{ sitemap_data.pages_count }} page{{ sitemap_data.pages_count|pluralize }} in this email · {{ sitemap_data.due_pages_count }} due in queue
          </mj-text>

          {% for page in sitemap_data.pages %}
          <mj-divider border-color="#eef2f7" border-width="1px" padding="0 0 12px 0" />
          <mj-text css-class="page-line" padding="0 0 8px 0">
            <span class="title">{{ page.title|default:page.url_path }}</span>
            <span class="muted"> · {{ page.url_path }}</span>
          </mj-text>
          <mj-button href="{{ page.review_url }}" background-color="#4f46e5" color="#ffffff" border-radius="6px" font-size="13px" font-weight="600" padding="0 0 8px 0" inner-padding="10px 16px" align="left">
            One-click review
          </mj-button>
          {% endfor %}
        </mj-column>
      </mj-section>
      {% endfor %}
    {% endfor %}

    <mj-section background-color="#f9fafb" padding="20px 24px 24px">
      <mj-column>
        <mj-text font-size="14px" color="#6b7280" align="center" line-height="20px">
          This is an automated reminder to keep client pages fresh and review-ready.
        </mj-text>
      </mj-column>
    </mj-section>

    <mj-section background-color="#f3f4f6" padding="20px">
      <mj-column>
        <mj-text font-size="12px" color="#9ca3af" align="center">
          © 2025 Cleanapp. All rights reserved.
        </mj-text>
      </mj-column>
    </mj-section>

  </mj-body>
</mjml>
{% endmjml %}
